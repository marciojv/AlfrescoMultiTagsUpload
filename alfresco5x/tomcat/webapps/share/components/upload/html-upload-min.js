(function(){var i=YAHOO.util.Dom,b=YAHOO.util.KeyListener;var f=Alfresco.util.encodeHTML;Alfresco.HtmlUpload=function(o){Alfresco.HtmlUpload.superclass.constructor.call(this,"Alfresco.HtmlUpload",o,["button","container"]);this.defaultShowConfig={siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false,adobeFlashEnabled:true,maximumFileSize:0};this.showConfig={};return this};YAHOO.extend(Alfresco.HtmlUpload,Alfresco.component.Base,{MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,defaultShowConfig:null,showConfig:null,versionSection:null,_fileName:null,metadataSection:null,m_tags:null,m_categories:null,_fileSize:null,_maximumFileSizeLimit:0,setMaximumFileSizeLimit:function d(o){this._maximumFileSizeLimit=o},getMaximumFileSizeLimit:function g(){return this._maximumFileSizeLimit},onReady:function n(){var s=this;i.removeClass(this.id+"-dialog","hidden");this.widgets.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.widgets.titleText=i.get(this.id+"-title-span");this.widgets.singleUploadTip=i.get(this.id+"-singleUploadTip-span");this.widgets.singleUpdateTip=i.get(this.id+"-singleUpdateTip-span");this.widgets.filedata=i.get(this.id+"-filedata-file");this.widgets.filedata.contentEditable=false;this.widgets.siteId=i.get(this.id+"-siteId-hidden");this.widgets.containerId=i.get(this.id+"-containerId-hidden");this.widgets.destination=i.get(this.id+"-destination-hidden");this.widgets.username=i.get(this.id+"-username-hidden");this.widgets.updateNodeRef=i.get(this.id+"-updateNodeRef-hidden");this.widgets.uploadDirectory=i.get(this.id+"-uploadDirectory-hidden");this.widgets.overwrite=i.get(this.id+"-overwrite-hidden");this.widgets.thumbnails=i.get(this.id+"-thumbnails-hidden");this.widgets.description=i.get(this.id+"-description-textarea");this.widgets.minorVersion=i.get(this.id+"-minorVersion-radioButton");this.widgets.versionSection=i.get(this.id+"-versionSection-div");this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.metadataSection=i.get(this.id+"-metadata-table-container");this.m_tags=i.get(this.id+"-custom-tag-picker");this.m_categories=i.get(this.id+"-custom-category-picker");this.m_tagsCurrentValueDisplayDiv=i.get(this.id+"-custom-tag-picker-cntrl-currentValueDisplay");this.m_categoriesCurrentValueDisplayDiv=i.get(this.id+"-custom-category-picker-cntrl-currentValueDisplay");var r=new Alfresco.forms.Form(this.id+"-htmlupload-form");this.widgets.form=r;YAHOO.util.Event.addListener(this.id+"-filedata-file","change",function(){if(this.files&&this.files.length>0){s._fileName=this.files[0].name;s._fileSize=this.files[0].size}});r.addValidation(this.id+"-filedata-file",Alfresco.forms.validation.mandatory,null,"change",this.msg("Alfresco.forms.validation.mandatory.message"));if(YAHOO.env.ua.ie==0){r.addValidation(this.id+"-filedata-file",function o(u,t){return !YAHOO.lang.isString(s._fileName)||Alfresco.forms.validation.nodeName({id:u.id,value:s._fileName},t)},null,"change",this.msg("message.illegalCharacters"));r.addValidation(this.id+"-filedata-file",function p(u,t){return t.maximumFileSizeLimit==0||!YAHOO.lang.isNumber(s._fileSize)||s._fileSize<=t.maximumFileSizeLimit},{maximumFileSizeLimit:this._maximumFileSizeLimit},"change",this.msg("message.maxFileFileSizeExceeded"));r.addValidation(this.id+"-filedata-file",function q(u,t){return !YAHOO.lang.isNumber(s._fileSize)||s._fileSize>0},null,"change",this.msg("message.zeroByteFileSelected"))}r.setSubmitElements(this.widgets.uploadButton);r.doBeforeFormSubmit={fn:function(){this.widgets.cancelButton.set("disabled",true);this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.uploading",this.name),spanClass:"wait",displayTime:0,effect:null})},obj:null,scope:this};r.setAJAXSubmit(true,{});r.applyTabFix();r.init();this.widgets.escapeListener=new b(document,{keys:b.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})},show:function m(o){this.resetGUI();this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,o);if(this.showConfig.uploadDirectory===undefined&&this.showConfig.updateNodeRef===undefined){throw new Error("An updateNodeRef OR uploadDirectory must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}this.widgets.escapeListener.enable()},resetGUI:function c(){if(this.m_tags!=null){this.m_tags.value=""}if(this.m_categories!=null){this.m_categories.value=""}if(this.m_tagsCurrentValueDisplayDiv!=null){this.m_tagsCurrentValueDisplayDiv.innerHTML=""}if(this.m_categoriesCurrentValueDisplayDiv!=null){this.m_categoriesCurrentValueDisplayDiv.innerHTML=""}},hide:function j(){this.onCancelButtonClick()},onUploadSuccess:function h(o){this.widgets.feedbackMessage.hide();var r=o.fileName?o.fileName:this.widgets.filedata.value;if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:r})}var p={successful:[{nodeRef:o.nodeRef,fileName:r,response:o}]};var q=this.showConfig.onFileUploadComplete;if(q&&typeof q.fn=="function"){q.fn.call((typeof q.scope=="object"?q.scope:this),p,q.obj)}},onUploadFailure:function l(p){this.widgets.feedbackMessage.hide();var o="message.failure."+p.status.code,q=Alfresco.util.message(o,this.name);if(q==o){q=p.status.code?p.status.code:Alfresco.util.message("message.failure",this.name)}Alfresco.util.PopupManager.displayPrompt({title:Alfresco.util.message("message.failure",this.name),text:q})},onCancelButtonClick:function e(){this.widgets.escapeListener.disable();this.widgets.panel.hide()},_applyConfig:function a(){var t;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){t=Alfresco.util.message("header.singleUpload",this.name)}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){t=Alfresco.util.message("header.singleUpdate",this.name)}}this.widgets.titleText.innerHTML=t;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){var r=Alfresco.util.message("label.singleUpdateTip",this.name,{"0":this.showConfig.updateFilename});this.widgets.singleUpdateTip.innerHTML=r;i.removeClass(this.widgets.versionSection,"hidden");var p=(this.showConfig.updateVersion||"1.0").split("."),o=parseInt(p[0],10),s=parseInt(p[1],10);i.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",o+"."+(1+s));i.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+o)+".0")}else{i.addClass(this.widgets.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){i.removeClass(this.widgets.singleUpdateTip,"hidden");i.addClass(this.widgets.singleUploadTip,"hidden")}else{i.addClass(this.widgets.singleUploadTip,"hidden");if(this.showConfig.adobeFlashEnabled){i.removeClass(this.widgets.singleUploadTip,"hidden")}i.addClass(this.widgets.singleUpdateTip,"hidden")}this.widgets.cancelButton.set("disabled",false);this.widgets.filedata.value=null;var q=i.get(this.id+"-htmlupload-form");if(this.showConfig.uploadURL===null){q.action=Alfresco.constants.PROXY_URI+"api/upload.html"}else{q.action=Alfresco.constants.PROXY_URI+this.showConfig.uploadURL}this.widgets.siteId.value=this.showConfig.siteId;this.widgets.containerId.value=this.showConfig.containerId;this.widgets.destination.value=this.showConfig.destination;this.widgets.username.value=this.showConfig.username;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){this.widgets.updateNodeRef.value=this.showConfig.updateNodeRef;this.widgets.uploadDirectory.value="";this.widgets.overwrite.value="";this.widgets.thumbnails.value=""}else{this.widgets.updateNodeRef.value="";this.widgets.uploadDirectory.value=this.showConfig.uploadDirectory;this.widgets.overwrite.value=this.showConfig.overwrite;this.widgets.thumbnails.value=this.showConfig.thumbnails}},_showPanel:function k(){this.widgets.description.value="";this.widgets.minorVersion.checked=true;this._applyConfig();this.widgets.panel.show()}})})();